name: update screenshots

on: workflow_dispatch

jobs:
    update:
        name: update screenshots
        runs-on: ubuntu-latest
        if: ${{ startsWith(github.ref, 'refs/heads/') }}
        steps:
            - uses: actions/checkout@v4
              with:
                  lfs: true

            - name: update screenshots
              shell: bash
              run: |
                  echo foo > file.txt

            - name: check git status
              id: git-status
              uses: actions/github-script@v7
              with:
                  script: |
                      const { stdout } = await exec.getExecOutput('git', ['status', '--porcelain']);

                      // return stdout.split('\n').some(line => /^\s+M\s+.*\.png$/.test(line));

                      return true;

            - name: update branch
              if: ${{ steps.git-status.outputs.result == 'true' }}
              uses: actions/github-script@v7
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  script: |
                      const fs = require('node:fs');

                      const githubToken = process.env.GITHUB_TOKEN;

                      await fs.writeFile(
                        `${process.env.HOME}/.netrc`,
                        `machine github.com\nlogin github-actions[bot]\npassword ${githubToken}`
                      );

                      await exec.exec('git', ['config', 'user.name', `"github-actions[bot]"`]);

                      await exec.exec('git', [
                          'config',
                          'user.email',
                          `"41898282+github-actions[bot]@users.noreply.github.com"`,
                      ]);

                      await exec.exec('git', ['add', '.']);

                      const message = 'test: updated screenshots';

                      await exec.exec('git', ['commit', '-n', '-m', message]);

                      const branch = context.ref.replace('refs/heads/', '');

                      await exec.exec('git', ['push', 'origin', `HEAD:${branch}`]);
